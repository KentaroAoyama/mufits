from typing import Dict
from pathlib import Path
import pickle
from pyproj import Transformer
from shapely import Polygon

CRS_WGS84 = "epsg:4326"
CRS_RECT = "epsg:6680"

X, Y, H = None, None, None
THETA, PHI = None, None

LOC_RIVERS: Dict = {
        "Tomakomai": {
            "in": (
                (141.42938025208986, 42.709305057331264),
                (141.42931314543213, 42.723075343499595),
                (141.41634362578856, 42.72330077436046),
                (141.41602519578962, 42.71952261014326),
                (141.41199380786568, 42.7173234121349),
                (141.40880630100943, 42.714759819036374),
                (141.4062865350909, 42.713415785516034),
                (141.40277406572923, 42.70841449853527),
                (141.40076609200221, 42.70573070731704),
                (141.39825642177559, 42.70231503782448),
                (141.39541109948738, 42.698655171361445),
                (141.3939149179519, 42.694631622445314),
                (141.3977737289312, 42.69768360948478),
                (141.4007934097567, 42.70012510409808),
                (141.40246335596524, 42.70305214210401),
                (141.40514738472916, 42.70524943974684),
                (141.4083348915854, 42.707813032845365),
                (141.41472712736052, 42.709406251795684),
                (141.41826572674822, 42.70904565743657),
                (141.4204480590125, 42.71051107680506),
                (141.42364684928907, 42.71075931205228),
            ),
            "out": (
                (141.42971709187987, 42.70930553242265),
                (141.42914294394444, 42.72344068877253),
                (141.41667868398588, 42.723666832270474),
                (141.41767732607133, 42.72610547633547),
                (141.41952638173098, 42.72683925497533),
                (141.42288230848223, 42.72940308561955),
                (141.42608050489457, 42.72977318180631),
                (141.43381475505163, 42.73246504957804),
                (141.4402188681113, 42.731621049737505),
                (141.44744964017602, 42.73394662205353),
                (141.4518315267672, 42.733343493543785),
                (141.4557069659449, 42.73298337427605),
                (141.46312337996724, 42.73177521689104),
                (141.46987383464455, 42.7289819171092),
                (141.47173595531723, 42.72703475507912),
                (141.47460859535988, 42.72508901832318),
                (141.476471903761, 42.72289813441402),
                (141.479524247119, 42.718637277352464),
                (141.4849320935501, 42.71486718968875),
                (141.49033993998123, 42.71109710202505),
                (141.49337149809125, 42.71110137784749),
                (141.5001249220897, 42.70769877336794),
                (141.50519474100233, 42.70417193249193),
                (141.5110918127843, 42.703692802832954),
                (141.51733166299854, 42.70199553886992),
                (141.5294739297728, 42.69872239679203),
                (141.5360731866177, 42.69239489221776),
                (141.54182321761687, 42.68752853118956),
                (141.545202305073, 42.68533978519161),
                (141.5465645108387, 42.68229516206857),
                (141.54842366219023, 42.680957304736204),
                (141.54827483981475, 42.676935656185606),
                (141.54659776723545, 42.67547094945418),
                (141.5454289236623, 42.67339765066212),
                (141.53969373926884, 42.67521748820176),
                (141.53749834199155, 42.6764330095032),
                (141.5334556706473, 42.67654916934616),
                (141.52620589492727, 42.67812314709549),
                (141.52115151648454, 42.67848160354339),
                (141.5184413576946, 42.68164618724044),
                (141.51557406242998, 42.68249517554049),
                (141.5068096953834, 42.68382329349952),
                (141.50056984516914, 42.685520557462546),
                (141.49534764069566, 42.68575691542521),
                (141.49162993185683, 42.6883107691504),
                (141.48993207402958, 42.69111119530297),
                (141.48486997535187, 42.693053843964925),
                (141.48131831095117, 42.696095378993974),
                (141.47911875662427, 42.69816392687222),
                (141.4780922029201, 42.70145274696572),
                (141.4694956619043, 42.70290296340999),
                (141.46679619267044, 42.703874050195274),
                (141.4649340719978, 42.70582121222535),
                (141.46036298026362, 42.7106892360734),
                (141.45850442277634, 42.71190523246623),
                (141.45141415898792, 42.71530736185439),
                (141.44771010902633, 42.715058413970105),
                (141.4440114038428, 42.71371271762993),
                (141.43830175561112, 42.71029253476924),
                (141.43375738776723, 42.70967681633786),
            ),
        },
        "Nishitappu": {
            "in": (
                (141.42970782759792, 42.676646563079515),
                (141.42904460002833, 42.7090608603608),
                (141.42314099573986, 42.71088046035475),
                (141.41909951212403, 42.71075289831862),
                (141.41859900335285, 42.70977729816521),
                (141.41371601412627, 42.70952668746108),
                (141.40615137159267, 42.70659133535595),
                (141.402294342206, 42.70317376549786),
                (141.4017997720771, 42.70097955594902),
                (141.39592883032117, 42.69609680426812),
                (141.39273835414377, 42.694142515867306),
                (141.3915790123983, 42.69011944204256),
                (141.3963048651502, 42.688054457349686),
                (141.40338919029637, 42.685870937356945),
                (141.4084495073814, 42.684293871513624),
                (141.4114893795906, 42.68259209418247),
                (141.41756080990984, 42.680894592673745),
                (141.42143149817375, 42.681509360922355),
                (141.42379709693873, 42.679928494347976),
            ),
            "out": (
                (141.42970782759792, 42.676646563079515),
                (141.42904460002833, 42.7090608603608),
                (141.4352743545507, 42.70943523237),
                (141.44082567857924, 42.71078354171277),
                (141.44569441506437, 42.71395881496593),
                (141.44922529421711, 42.715182412820866),
                (141.45428620516634, 42.713483486038),
                (141.4524282415433, 42.71457762149129),
                (141.457495684999, 42.71153822437345),
                (141.46154667044246, 42.7097160113769),
                (141.46475971346052, 42.70703958407509),
                (141.46527922588697, 42.70411563416314),
                (141.47033894910777, 42.70266042925936),
                (141.46816018002883, 42.700463844253605),
                (141.4656546668518, 42.696195148184245),
                (141.46567307664284, 42.69241745905842),
                (141.46685973614282, 42.690834929664206),
                (141.4656873293843, 42.6894927965094),
                (141.468896809217, 42.687547534844846),
                (141.46924374469887, 42.685476373964),
                (141.47245203680308, 42.683774834178536),
                (141.47567636324146, 42.67878304902541),
                (141.47822522850714, 42.67415589650816),
                (141.47789789054477, 42.67220564638409),
                (141.47995277954578, 42.66526242337845),
                (141.48418109284765, 42.66161253383445),
                (141.48336809271981, 42.6556401600684),
                (141.48254143371472, 42.652470587911836),
                (141.48238429724003, 42.650154992514835),
                (141.4822325055434, 42.64674264866195),
                (141.47903252753838, 42.646738135293816),
                (141.47735070404528, 42.64624831607873),
                (141.47447628240994, 42.6485596356533),
                (141.4744626235327, 42.651362437262776),
                (141.4744436198774, 42.655261987328146),
                (141.47240832839591, 42.658183799328874),
                (141.47070156260526, 42.66281213957459),
                (141.46564540256983, 42.66353617884111),
                (141.4600726994291, 42.66657486332187),
                (141.457864831003, 42.67034946435371),
                (141.45583607202803, 42.671930806019475),
                (141.4544798049046, 42.673756819747084),
                (141.45009673058496, 42.674603670135916),
                (141.44757280761687, 42.674112663192375),
                (141.44470491848801, 42.67508351243197),
                (141.44083126090297, 42.675078048881076),
                (141.43846922532336, 42.67592774981819),
                (141.43291136878833, 42.675919910810386),
            ),
        },
        "Nishitappusawa": {
            "in": (
                (141.42940127488353, 42.67043118007145),
                (141.4297072337337, 42.67676842401906),
                (141.4244684010618, 42.68041688828891),
                (141.42244439300066, 42.68102334243833),
                (141.41823330176138, 42.6811392647356),
                (141.4140174596083, 42.6822300745492),
                (141.41149116118328, 42.68222651136384),
                (141.4084501012456, 42.68417201057408),
                (141.40288155515447, 42.686357668478045),
                (141.39866155595178, 42.68830150486845),
                (141.39343756988558, 42.688903445649736),
                (141.3909160223744, 42.68792499494803),
                (141.39092552420203, 42.68597521991534),
                (141.39970295626162, 42.681966161286375),
                (141.40426870321772, 42.67819488589421),
                (141.40916653905, 42.67539897310977),
                (141.4147356790054, 42.67309145426626),
                (141.42080117068235, 42.67261256215298),
                (141.42568594150163, 42.672497590038475),
            ),
            "out": (
                (141.42940127488353, 42.67043118007145),
                (141.4297072337337, 42.67676842401906),
                (141.43409327737447, 42.675312268932515),
                (141.4393125125268, 42.67568521566756),
                (141.44150790980413, 42.674469694366124),
                (141.44588504548148, 42.67484145337272),
                (141.44689912803685, 42.67411171300961),
                (141.45110784381922, 42.674483234470515),
                (141.45533081234302, 42.6719300933824),
                (141.45837246614494, 42.66986273323261),
                (141.45889019697873, 42.66730436613929),
                (141.4642974495456, 42.663656139415124),
                (141.47019808451293, 42.662445844118885),
                (141.4719024748467, 42.65830494763134),
                (141.47444005669203, 42.6559931529654),
                (141.4742942036377, 42.651362199717084),
                (141.4743048931938, 42.64916870280532),
                (141.47701267652684, 42.64649156286644),
                (141.47635384355252, 42.64344408919511),
                (141.47417388674515, 42.64149122606844),
                (141.4694557542282, 42.64197201854726),
                (141.46759007037016, 42.6446503462146),
                (141.46775255162288, 42.64586919315571),
                (141.46336591411787, 42.6474472091818),
                (141.45931136548907, 42.65000058781561),
                (141.4591352253591, 42.651584542483974),
                (141.45541395333493, 42.65486956184642),
                (141.44630265080647, 42.6582688406863),
                (141.4452844112015, 42.6598516076262),
                (141.44275633118377, 42.660213627259466),
                (141.44021518615307, 42.663256587562664),
                (141.43648500616547, 42.668369521018256),
                (141.43277323596894, 42.66970476534802),
            ),
        },
        "Kumanosawa": {
            "in": (
                (141.42316014192255, 42.651655663663895),
                (141.4300316736386, 42.65166535552809),
                (141.42933200656, 42.670821040059714),
                (141.42484443589083, 42.67237454137048),
                (141.42012749110233, 42.67261161197021),
                (141.4145678529746, 42.672969355781035),
                (141.41068706901885, 42.674426223504646),
                (141.40949803406195, 42.676496196657034),
                (141.40579042091503, 42.67697841441),
                (141.4037586926189, 42.67916906077348),
                (141.3990417478304, 42.67940613137321),
                (141.39499254397964, 42.68086276155114),
                (141.3914468182212, 42.682685687184765),
                (141.38857655363543, 42.684143980182526),
                (141.38403871829803, 42.68218779141618),
                (141.3879367243164, 42.67719695644583),
                (141.393169618346, 42.674767101571405),
                (141.3962106782837, 42.67282160236116),
                (141.39841795284553, 42.66916886226886),
                (141.39943738017897, 42.66734237344987),
                (141.40281765536355, 42.664909905572834),
                (141.40569564018426, 42.66186742036102),
                (141.4084010480604, 42.659677724180305),
                (141.41228836452265, 42.65688038612172),
                (141.41751650763845, 42.655425418763635),
                (141.4202207277861, 42.65347944446201),
            ),
            "out": (
                (141.42316014192255, 42.651655663663895),
                (141.4300316736386, 42.65166535552809),
                (141.42933200656, 42.670821040059714),
                (141.4370269191506, 42.66776097646675),
                (141.43886865840298, 42.66308408188178),
                (141.44089302278266, 42.66240451116863),
                (141.4424194913938, 42.66021315216808),
                (141.44427389183147, 42.65985018235206),
                (141.45052146228068, 42.656568726174974),
                (141.45575435631028, 42.654138871300546),
                (141.45998148188372, 42.650732703635626),
                (141.46015584042098, 42.649514331785895),
                (141.46302848046366, 42.64756859502996),
                (141.462210729422, 42.64257110878025),
                (141.4627243032062, 42.64086576826373),
                (141.46155486576882, 42.638914330411204),
                (141.45617790027754, 42.63634764921869),
                (141.45285107287347, 42.62781263253688),
                (141.44813828513458, 42.62719667655982),
                (141.44509366201152, 42.62987334140732),
                (141.44239359891344, 42.63096628913215),
                (141.44204903888848, 42.63255000625482),
                (141.43714585827814, 42.63644266749514),
                (141.43646148914203, 42.638635214224145),
                (141.43409173332748, 42.64106910737532),
                (141.43458808504906, 42.64289773410554),
                (141.43019075798796, 42.64666924704339),
                (141.4263081924395, 42.64849169758564),
                (141.42596303855032, 42.650197275647855),
            ),
        },
        "Oboppu": {
            "in": (
                (141.39749223728725, 42.651765694828015),
                (141.42275664681162, 42.65150886042678),
                (141.41849393689367, 42.6553049355891),
                (141.4152617001838, 42.65500790845692),
                (141.41019271268107, 42.658364144017575),
                (141.40532084059282, 42.662744296525204),
                (141.3994377364975, 42.667269256886144),
                (141.39658262732684, 42.67252965870678),
                (141.3915164903724, 42.675300961757614),
                (141.3868481474323, 42.67938893306518),
                (141.38420725696588, 42.682163656773966),
                (141.38259113861093, 42.682015143207884),
                (141.37834553198275, 42.68230162331137),
                (141.3747112254361, 42.681565326687185),
                (141.37856331387238, 42.679084779562274),
                (141.38303525403506, 42.673826658180275),
                (141.38648313472333, 42.6713455409457),
                (141.38811564373097, 42.668130692580405),
                (141.39237122727818, 42.6657969486926),
                (141.39441792095283, 42.66053540665265),
                (141.39484279517595, 42.656295216066226),
            ),
            "out": (
                (141.39749223728725, 42.651765694828015),
                (141.42275664681162, 42.65150886042678),
                (141.4259967225293, 42.65019732315699),
                (141.42620666541112, 42.64858904380986),
                (141.43025943244726, 42.646401247994675),
                (141.43411722198013, 42.64275083585015),
                (141.43412791153622, 42.640557338938386),
                (141.43696591741713, 42.63880653217658),
                (141.43758505650646, 42.636175191046945),
                (141.4416428120021, 42.6329637633396),
                (141.44245764123178, 42.631648805411864),
                (141.44773514634215, 42.626976756758985),
                (141.44754301938718, 42.624929207919834),
                (141.4404643953376, 42.62594286289297),
                (141.4329822761771, 42.62680971462899),
                (141.4257022608906, 42.62767685141984),
                (141.4214566542624, 42.627963331523326),
                (141.41639621840457, 42.629564769554555),
                (141.41294192398263, 42.633361984936194),
                (141.41192000241944, 42.63570028970126),
                (141.40908342181268, 42.63715863020817),
                (141.40846570799752, 42.6394975050829),
                (141.4056255642054, 42.641687011227056),
                (141.40520852899007, 42.64431863741152),
                (141.4023669599238, 42.64680060981058),
                (141.3993261375318, 42.648697364645),
            ),
        },
        "Tarumai": {
            "in": (
                (141.34818102994203, 42.651257442067305),
                (141.39789715767233, 42.651620031810225),
                (141.39277543502618, 42.665797518802265),
                (141.38892405922695, 42.66813183279972),
                (141.38466633776852, 42.670904276069884),
                (141.37471265071022, 42.68127286043228),
                (141.37026707811927, 42.68112035609858),
                (141.3674340606979, 42.681847530968234),
                (141.36240141768587, 42.67774587702886),
                (141.3622335203914, 42.67072640185637),
                (141.35860277703011, 42.66925893959493),
                (141.35700661251323, 42.66501589846021),
                (141.35398716923345, 42.6625256594711),
                (141.35119120893987, 42.65564871171328),
            ),
            "out": (
                (141.34818102994203, 42.651257442067305),
                (141.39789715767233, 42.651620031810225),
                (141.3993289880801, 42.6481124321352),
                (141.4031753754198, 42.646801750029894),
                (141.4062318758274, 42.64168786639154),
                (141.40846428272337, 42.6397899713378),
                (141.40888986958356, 42.63540354762392),
                (141.41295831463532, 42.629998623004816),
                (141.4145922489171, 42.626491308384615),
                (141.41399306366583, 42.62502812194562),
                (141.42514013276715, 42.618609542353376),
                (141.4281845183445, 42.615981621881694),
                (141.42879795633723, 42.61452014577167),
                (141.42455520025734, 42.61422169336535),
                (141.4194969023107, 42.61538443201423),
                (141.41747657620778, 42.61523534833848),
                (141.4152498704084, 42.61596337837262),
                (141.4128338882023, 42.6140589270578),
                (141.40554389599677, 42.61697332763297),
                (141.40231237192398, 42.61653006737335),
                (141.3946302868007, 42.616957934672186),
                (141.38915780418702, 42.620167366995716),
                (141.38248338788546, 42.62118159207851),
                (141.37559902870206, 42.62380409650844),
                (141.36911745199254, 42.62671963730292),
                (141.36304150830517, 42.62934328195216),
                (141.35797537135073, 42.632114585003),
                (141.35351910920366, 42.634155577581076),
                (141.35048113735996, 42.63546739990569),
                (141.35046332143315, 42.639123228091975),
                (141.34943569877336, 42.642631397876656),
                (141.3463863247365, 42.6462829502405),
                (141.34758398260198, 42.64935555624595),
            ),
        },}

# TODO:
def calc_grad(use_cache: bool = True):
    pth_dem = Path(r"C:\Users\KentaroAoyama\OneDrive\ドキュメント\GitHub\mufits\generate_input\dem\out.xyz",)
    cache_pth = Path("./cache")
    if use_cache and cache_pth.exists():
        with open(cache_pth, "rb") as pkf:
            X, Y, H, THETA, PHI = pickle.load(pkf)
            return X, Y, H, THETA, PHI
    lng_ls, lat_ls, h_ls = [], [], []
    with open(pth_dem, "r") as f:
        for line in f.readlines():
            line = line.replace("\n", "")
            strs = line.split(" ")
            lng_ls.append(strs[0])
            lat_ls.append(strs[1])


def calc_inout_areas():
    rect_trans = Transformer.from_crs(CRS_WGS84, CRS_RECT, always_xy=True)
    river_dist: Dict = {}
    for river, inout in LOC_RIVERS.items():
        in_area, out_area = 0.0, 0.0
        for key, lnglat_ls in inout.items():
            lng_ls = [lnglat[0] for lnglat in lnglat_ls]
            lat_ls = [lnglat[1] for lnglat in lnglat_ls]
            x_ls, y_ls = rect_trans.transform(lng_ls, lat_ls)
            p = Polygon(((x, y) for x, y in zip(x_ls, y_ls)))
            if key == "in":
                in_area += p.area
            if key == "out":
                out_area += p.area
        river_dist.setdefault(river, (in_area, out_area))
    return river_dist


if __name__ == "__main__":
    river_inout_areas = calc_inout_areas()
    print(river_inout_areas)
    # with open("river_inout_areas.pkl", "wb") as pkf:
    #     pickle.dump(river_inout_areas, pkf, pickle.HIGHEST_PROTOCOL)
    # calc_grad()
    pass
